<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - InstaBooster</title>
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #050505; --primary: #00f3ff; --secondary: #ff00ff; --card-bg: rgba(20, 20, 30, 0.95); }
        * { box-sizing: border-box; }
        
        body { 
            background-color: var(--bg); color: #fff; font-family: 'Rajdhani', sans-serif; 
            margin: 0; padding: 0; padding-bottom: 80px; min-height: 100vh;
        }

        /* --- UI ELEMENTS --- */
        .admin-header {
            background: rgba(10,10,15,0.95); border-bottom: 1px solid #333;
            padding: 15px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px);
        }

        .cyber-card { 
            background: var(--card-bg); border: 1px solid #333; 
            border-left: 3px solid var(--primary); border-radius: 8px; 
            padding: 15px; margin-bottom: 15px; position: relative;
        }
        
        .cyber-input {
            background: #000; border: 1px solid #444; color: #fff;
            padding: 8px; width: 100%; border-radius: 4px; margin-bottom: 8px;
        }
        .cyber-input:focus { outline: none; border-color: var(--secondary); }

        .btn-neon {
            background: var(--primary); color: #000; border: none; font-weight: bold;
            padding: 8px 15px; border-radius: 4px; text-transform: uppercase; font-family: 'Orbitron', sans-serif; font-size: 0.8rem;
        }
        
        .btn-edit {
            background: transparent; border: 1px solid var(--secondary); color: var(--secondary);
            border-radius: 5px; padding: 2px 8px; font-size: 0.8rem; transition: 0.3s;
        }
        .btn-edit:hover { background: var(--secondary); color: #fff; }

        /* --- USER DATA MODAL --- */
        #user-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; overflow-y: auto; padding-top: 50px;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #111; border: 1px solid var(--secondary); border-radius: 10px;
            padding: 20px; width: 90%; max-width: 500px; margin: 0 auto;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.2);
        }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 15px; }

        /* --- BOTTOM NAV --- */
        .nav-dock {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: #111; border-top: 1px solid #333;
            display: flex; justify-content: space-around; align-items: center; z-index: 1000;
        }
        .nav-item { background: none; border: none; color: #555; font-size: 1.2rem; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--secondary); }
        .nav-item span { font-size: 0.7rem; margin-top: 2px; }
        
        /* Helpers */
        .user-row { border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        .data-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .label-text { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .value-text { font-size: 1rem; font-weight: 600; color: #fff; }
        .link-box { background: #111; padding: 5px; border-radius: 4px; font-family: monospace; color: var(--primary); word-break: break-all; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center;}
        .time-badge { font-size: 0.65rem; color: #aaa; display: block; margin-bottom: 5px; font-family: monospace; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="admin-header">
        <div class="font-tech fw-bold" style="font-family:'Orbitron'; font-size: 1.2rem;">ADMIN<span style="color:var(--secondary)">PANEL</span></div>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()"><i class="fas fa-power-off"></i></button>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="view-login" class="container mt-5" style="display:block;">
        <div class="cyber-card mx-auto" style="max-width: 400px; border-left: 3px solid var(--secondary);">
            <h3 class="text-center mb-4 font-tech">SECURE ACCESS</h3>
            <input type="email" id="a-mail" class="cyber-input" placeholder="Admin Email">
            <input type="password" id="a-pass" class="cyber-input" placeholder="Password">
            <button class="btn-neon w-100 mt-3" style="background:var(--secondary); color:#fff;" onclick="adminLogin()">AUTHENTICATE</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="view-app" class="container mt-3" style="display:none;">
        
        <!-- ORDERS TAB -->
        <div id="tab-orders" class="tab-view">
            <h6 class="text-secondary mb-3 font-tech">MANAGE ORDERS</h6>
            <div id="list-orders"></div>
        </div>

        <!-- USERS TAB -->
        <div id="tab-users" class="tab-view" style="display:none;">
            <h6 class="text-warning mb-3 font-tech">USER MANAGEMENT</h6>
            <div class="cyber-card">
                <input id="search-user" class="cyber-input" placeholder="Search by Email..." oninput="filterUsers()">
            </div>
            <div id="list-users">
                <div class="text-center text-white-50 mt-5">Loading Users...</div>
            </div>
        </div>

        <!-- FUNDS TAB -->
        <div id="tab-funds" class="tab-view" style="display:none;">
            <h6 class="text-success mb-3 font-tech">FUND REQUESTS</h6>
            <div id="list-funds"></div>
        </div>

        <!-- SERVICES TAB -->
        <div id="tab-services" class="tab-view" style="display:none;">
            <h6 class="text-info mb-3 font-tech">SERVICES & CATEGORIES</h6>
            <div class="cyber-card p-2 mb-3" style="border-left-color: #fff;">
                <div class="input-group">
                    <input id="c-name" class="form-control bg-dark text-white border-secondary" placeholder="New Category Name">
                    <button class="btn btn-warning" onclick="addCategory()">ADD CAT</button>
                </div>
            </div>
            <div class="cyber-card">
                <h6 class="text-white-50 small mb-2">ADD NEW SERVICE</h6>
                <select id="s-cat" class="cyber-input"></select>
                <input id="s-name" class="cyber-input" placeholder="Service Name">
                <div class="d-flex gap-2">
                    <input id="s-rate" type="number" class="cyber-input" placeholder="Rate (₹/1000)">
                    <input id="s-time" class="cyber-input" placeholder="Time (e.g. 1hr)">
                </div>
                <textarea id="s-desc" class="cyber-input" rows="2" placeholder="Description"></textarea>
                <button class="btn-neon w-100" onclick="addService()">PUBLISH SERVICE</button>
            </div>
            <div id="list-services"></div>
        </div>
    </div>

    <!-- USER DETAILS MODAL -->
    <div id="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="m-0 text-secondary font-tech">USER INSPECTOR</h5>
                <button class="btn btn-sm btn-danger" onclick="closeUserModal()"><i class="fas fa-times"></i></button>
            </div>
            <div id="modal-body" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <div id="nav-dock" class="nav-dock" style="display:none;">
        <button class="nav-item active" onclick="nav('orders', this)"><i class="fas fa-shopping-bag"></i><span>Orders</span></button>
        <button class="nav-item" onclick="nav('users', this)"><i class="fas fa-users"></i><span>Users</span></button>
        <button class="nav-item" onclick="nav('funds', this)"><i class="fas fa-wallet"></i><span>Funds</span></button>
        <button class="nav-item" onclick="nav('services', this)"><i class="fas fa-layer-group"></i><span>Services</span></button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
       const firebaseConfig = {
  apiKey: "AIzaSyAmoVgzLDMb9hAHX9L_n5oKTSw5_Q9uz1Q",
  authDomain: "instabooster-a2e49.firebaseapp.com",
  databaseURL: "https://instabooster-a2e49-default-rtdb.firebaseio.com",
  projectId: "instabooster-a2e49",
  storageBucket: "instabooster-a2e49.firebasestorage.app",
  messagingSenderId: "69575684016",
  appId: "1:69575684016:web:89808125f3922d8469b075"
};
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), db = firebase.database();
        let allUsersData = [];

        // --- HELPER: FORMAT DATE ---
        function formatTime(ts){
            if(!ts) return 'Unknown Date';
            const d = new Date(ts);
            return d.toLocaleString('en-US', { month:'short', day:'numeric', hour:'numeric', minute:'numeric', hour12:true });
        }

        // AUTH
        function adminLogin(){
            const e = document.getElementById('a-mail').value;
            const p = document.getElementById('a-pass').value;
            auth.signInWithEmailAndPassword(e, p).then(u=>{
                if(u) {
                    document.getElementById('view-login').style.display='none';
                    document.getElementById('view-app').style.display='block';
                    document.getElementById('nav-dock').style.display='flex';
                    initAdmin();
                }
            }).catch(er=>alert(er.message));
        }

        function logout(){ auth.signOut().then(()=>location.reload()); }

        function nav(t, el){
            document.querySelectorAll('.tab-view').forEach(x=>x.style.display='none');
            document.getElementById('tab-'+t).style.display='block';
            document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
            el.classList.add('active');
        }

        function initAdmin(){
            loadOrders();
            loadFunds();
            loadServices();
            loadUsers();
        }

        // --- 1. ORDERS (With Edit) ---
        function loadOrders(){
            db.ref('orders').on('value', s => {
                const list = document.getElementById('list-orders');
                let html = '';
                let array = [];
                s.forEach(child => { let obj=child.val(); obj.key=child.key; array.push(obj); });
                array.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

                if(array.length === 0) { list.innerHTML = '<div class="text-center mt-5 text-white-50">No Orders</div>'; return; }

                array.forEach(o => {
                    let stClass = o.status=='Pending'?'text-warning':(o.status=='Completed'?'text-success':'text-danger');
                    let borderClass = o.status=='Pending'?'#ffc107':(o.status=='Completed'?'#198754':'#dc3545');
                    
                    let buttons = o.status === 'Pending' ? `
                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-sm btn-success w-50" onclick="setStatus('${o.key}','Completed')">Complete</button>
                            <button class="btn btn-sm btn-danger w-50" onclick="setStatus('${o.key}','Cancelled')">Cancel</button>
                        </div>` : '';

                    html += `
                    <div class="cyber-card p-3" style="border-left-color:${borderClass}">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <span class="badge bg-secondary">#${o.key.slice(-4)}</span>
                                <span class="time-badge m-0 d-inline ms-2"><i class="far fa-clock"></i> ${formatTime(o.timestamp)}</span>
                            </div>
                            <button class="btn-edit" onclick="editOrder('${o.key}', '${o.link}', '${o.quantity}')"><i class="fas fa-edit"></i> Edit</button>
                        </div>
                        <div class="mb-2">
                            <span class="${stClass} fw-bold text-uppercase">${o.status}</span>
                        </div>

                        <h6 class="text-white mb-2">${o.serviceName}</h6>
                        <div class="data-row bg-dark p-2 rounded mb-2 border border-secondary">
                            <div class="text-center"><div class="label-text">Qty</div><div class="value-text text-white">${o.quantity}</div></div>
                             <div class="text-center"><div class="label-text">Total</div><div class="value-text text-primary">₹${o.charge}</div></div>
                        </div>
                        <div class="link-box mb-2">
                            <span class="text-truncate" style="max-width: 200px;">${o.link}</span>
                            <i class="fas fa-copy" style="cursor:pointer" onclick="navigator.clipboard.writeText('${o.link}').then(()=>alert('Copied!'))"></i>
                        </div>
                        <small class="text-white-50 d-block text-end" style="font-size:0.7rem;">User: ${o.uid}</small>
                        ${buttons}
                    </div>`;
                });
                list.innerHTML = html;
            });
        }
        
        function setStatus(k, s){ if(confirm("Set status to "+s+"?")) db.ref('orders/'+k).update({status:s}); }
        
        function editOrder(key, oldLink, oldQty){
            let newLink = prompt("Edit Link:", oldLink);
            let newQty = prompt("Edit Quantity:", oldQty);
            if(newLink && newQty){
                db.ref('orders/'+key).update({link: newLink, quantity: parseInt(newQty)});
            }
        }

        // --- 2. USERS ---
        function loadUsers(){
            db.ref('users').on('value', s => {
                allUsersData = [];
                s.forEach(child => {
                    let u = child.val();
                    u.key = child.key;
                    allUsersData.push(u);
                });
                renderUserList(allUsersData);
            });
        }

        function renderUserList(arr){
            const list = document.getElementById('list-users');
            let html = '';
            if(arr.length === 0) { list.innerHTML = '<div class="text-center text-white-50 mt-5">No Users Found</div>'; return; }
            arr.forEach(u => {
                html += `
                <div class="cyber-card p-3 user-row">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="fw-bold text-white text-break" style="font-size:0.95rem;">${u.email}</div>
                            <small class="text-white-50" style="font-size:0.7rem;">UID: ${u.key}</small>
                        </div>
                        <div class="text-end">
                            <span class="d-block text-primary fw-bold">₹${(u.balance||0).toFixed(2)}</span>
                            <small class="text-white-50">Spent: ₹${(u.spent||0).toFixed(2)}</small>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mt-3 pt-2 border-top border-secondary">
                        <button class="btn btn-sm btn-outline-warning w-50" onclick="editBalance('${u.key}', ${u.balance||0})"><i class="fas fa-edit"></i> Edit Bal</button>
                        <button class="btn btn-sm btn-outline-info w-50" onclick="inspectUser('${u.key}', '${u.email}')"><i class="fas fa-eye"></i> View Data</button>
                    </div>
                </div>`;
            });
            list.innerHTML = html;
        }
        function filterUsers(){
            const q = document.getElementById('search-user').value.toLowerCase();
            const filtered = allUsersData.filter(u => u.email.toLowerCase().includes(q));
            renderUserList(filtered);
        }
        function editBalance(uid, cur){
            let amt = prompt("Enter new Balance for User:", cur);
            if(amt != null && !isNaN(amt)){ db.ref('users/'+uid).update({balance: parseFloat(amt)}); }
        }

        // --- INSPECT USER ---
        function inspectUser(uid, email){
            const modal = document.getElementById('user-modal');
            const body = document.getElementById('modal-body');
            modal.style.display = 'block';
            body.innerHTML = '<div class="text-center text-white py-5"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            Promise.all([
                db.ref('orders').once('value'),
                db.ref('funds').once('value')
            ]).then((snaps) => {
                const ordersSnap = snaps[0];
                const fundsSnap = snaps[1];
                let userOrders = [], userFunds = [];

                ordersSnap.forEach(child => { if(child.val().uid === uid) userOrders.push(child.val()); });
                fundsSnap.forEach(child => { if(child.val().uid === uid) userFunds.push(child.val()); });

                userOrders.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
                userFunds.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));

                let oHtml = '<h6 class="text-warning mt-4 mb-2 border-bottom border-secondary pb-1">ORDER HISTORY</h6>';
                if(userOrders.length === 0) oHtml += '<small class="text-white-50 d-block text-center py-2">No Orders</small>';
                else {
                    userOrders.forEach(v => {
                        oHtml += `<div class="mb-2 p-2 bg-dark rounded border border-secondary small">
                            <div class="d-flex justify-content-between">
                                <span class="text-white fw-bold text-truncate" style="max-width:60%">${v.serviceName}</span>
                                <span class="${v.status=='Pending'?'text-warning':(v.status=='Completed'?'text-success':'text-danger')}">${v.status}</span>
                            </div>
                            <div class="d-flex justify-content-between text-white-50 mt-1">
                                <span>Qty: ${v.quantity}</span>
                                <span>₹${v.charge}</span>
                            </div>
                            <div class="text-secondary mt-1" style="font-size:0.65rem;"><i class="far fa-clock"></i> ${formatTime(v.timestamp)}</div>
                        </div>`;
                    });
                }

                let fHtml = '<h6 class="text-success mt-4 mb-2 border-bottom border-secondary pb-1">FUND HISTORY</h6>';
                if(userFunds.length === 0) fHtml += '<small class="text-white-50 d-block text-center py-2">No Funds</small>';
                else {
                    userFunds.forEach(v => {
                        fHtml += `<div class="mb-2 p-2 bg-dark rounded border border-secondary small">
                            <div class="d-flex justify-content-between">
                                <span class="text-white fw-bold">₹${v.amount}</span>
                                <span class="${v.status=='Pending'?'text-warning':(v.status=='Approved'?'text-success':'text-danger')}">${v.status}</span>
                            </div>
                            <div class="text-white-50 mt-1">Txn: ${v.txnId}</div>
                            <div class="text-secondary mt-1" style="font-size:0.65rem;"><i class="far fa-clock"></i> ${formatTime(v.timestamp)}</div>
                        </div>`;
                    });
                }

                body.innerHTML = `<div class="text-center mb-3"><h5 class="text-white m-0">${email}</h5><small class="text-secondary">${uid}</small></div>${oHtml}${fHtml}`;
            });
        }
        function closeUserModal(){ document.getElementById('user-modal').style.display = 'none'; }

        // --- 3. FUNDS (With Edit) ---
        function loadFunds(){
            db.ref('funds').on('value', s => {
                const list = document.getElementById('list-funds');
                let html = '';
                let array = [];
                s.forEach(child => { let obj=child.val(); obj.key=child.key; array.push(obj); });
                array.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

                if(array.length === 0) { list.innerHTML = '<div class="text-center mt-5 text-white-50">No Requests</div>'; return; }

                array.forEach(f => {
                    let stClass = f.status=='Pending'?'text-warning':(f.status=='Approved'?'text-success':'text-danger');
                    let btns = f.status === 'Pending' ? `
                        <div class="mt-2 d-flex gap-2">
                            <button class="btn btn-sm btn-success w-50" onclick="fundAction('${f.key}','${f.uid}',${f.amount},'Approve')">Approve</button>
                            <button class="btn btn-sm btn-danger w-50" onclick="fundAction('${f.key}','${f.uid}',${f.amount},'Reject')">Reject</button>
                        </div>` : '';
                    html += `
                    <div class="cyber-card p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="m-0 text-white">₹${f.amount}</h4>
                                <div class="text-info mt-1" style="font-family:monospace; letter-spacing:1px;">ID: ${f.txnId}</div>
                            </div>
                            <div>
                                <button class="btn-edit mb-2 d-block ms-auto" onclick="editFund('${f.key}', ${f.amount}, '${f.txnId}')"><i class="fas fa-edit"></i> Edit</button>
                                <span class="${stClass} fw-bold d-block text-end">${f.status}</span>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                             <small class="text-white-50">${f.email}</small>
                             <div class="time-badge"><i class="far fa-clock"></i> ${formatTime(f.timestamp)}</div>
                        </div>
                        ${btns}
                    </div>`;
                });
                list.innerHTML = html;
            });
        }
        
        function editFund(key, oldAmt, oldTxn){
            let newAmt = prompt("Edit Amount:", oldAmt);
            let newTxn = prompt("Edit Txn ID:", oldTxn);
            if(newAmt && newTxn){
                db.ref('funds/'+key).update({amount: parseFloat(newAmt), txnId: newTxn});
            }
        }

        function fundAction(key, uid, amt, action){
            if(action === 'Reject'){
                if(confirm("Reject?")) db.ref('funds/'+key).update({status:'Rejected'});
            } else {
                if(confirm("Add ₹"+amt+" to user wallet?")){
                    db.ref('users/'+uid).once('value', s=>{
                        let cur = s.val().balance || 0;
                        db.ref('users/'+uid).update({balance: cur + parseFloat(amt)});
                        db.ref('funds/'+key).update({status: 'Approved'});
                        alert("Added!");
                    });
                }
            }
        }

        // --- 4. SERVICES ---
        function loadServices(){
            db.ref('categories').on('value', s => {
                const sel = document.getElementById('s-cat');
                sel.innerHTML = '<option value="">Select Category</option>';
                s.forEach(x => { sel.innerHTML += `<option value="${x.key}">${x.val().name}</option>`; });
            });
            db.ref('services').on('value', s => {
                const list = document.getElementById('list-services');
                let html = '';
                s.forEach(x => {
                    let sv = x.val();
                    html += `
                    <div class="cyber-card p-2 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold text-white">${sv.name}</div>
                            <div class="small text-white-50">Rate: ₹${sv.rate} | Time: ${sv.time}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="if(confirm('Delete?')) db.ref('services/${x.key}').remove()"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
                list.innerHTML = html;
            });
        }
        function addCategory(){
            const n = document.getElementById('c-name').value;
            if(n) db.ref('categories').push({name:n}).then(()=>{ alert('Category Added'); document.getElementById('c-name').value=''; });
        }
        function addService(){
            const cat = document.getElementById('s-cat').value;
            const nm = document.getElementById('s-name').value;
            const rt = document.getElementById('s-rate').value;
            const tm = document.getElementById('s-time').value;
            const ds = document.getElementById('s-desc').value;
            if(cat && nm && rt){
                db.ref('services').push({ catId: cat, name: nm, rate: parseFloat(rt), time: tm, desc: ds }).then(()=>{ alert('Published'); });
            } else { alert("Please fill details"); }
        }
    </script>
</body>
</html>